{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workspaceName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Log Analytics workspace"
        }
      },
      "automationAccountName": {
        "type": "string",
        "defaultValue": "not-used-here",
        "metadata": {
          "description": "For template compatibility purposes with global parameter file, not used in this template"
        }
      },
      "enabledSolutions": {
        "type": "array",
        "defaultValue": ["all"],
        "metadata": {
          "description": "Deployed solutions. Use 'all' to deploy alerts for all solutions."
        }
      },
      "criticalAlertWebhooks": {
        "type": "array",
        "defaultValue": [
          {
          "name": "ServiceNow",
          "serviceUri": "https://Event_Management_Azure:KSRQYCYkWY4wKm2uSA@tieto.service-now.com/api/global/em/inbound_event?source=AzureLogAnalyticsEvent"
          }
        ] 
      },
      "criticalAlertEmailReceivers": {
        "type": "array",
        "defaultValue": [
          {
          "name": "Email Tieto Default",
          "emailAddress": "tietomanagedazurealerts@tieto.com"
          }
        ]
      },
      "warningAlertWebhooks": {
        "type": "array",
        "defaultValue": [
          {
          "name": "ServiceNow",
          "serviceUri": "https://Event_Management_Azure:KSRQYCYkWY4wKm2uSA@tieto.service-now.com/api/global/em/inbound_event?source=AzureLogAnalyticsEvent"
          }
        ] 
      },
      "warningAlertEmailReceivers": {
        "type": "array",
        "defaultValue": [
          {
          "name": "Email Tieto Default",
          "emailAddress": "tietomanagedazurealerts@tieto.com"
          }
        ]
      }

    },
    "variables": {
      "alertTag": "[concat('hidden-link:', resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')))]",
      "alertSource":{
        "SourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
        "Type": "ResultCount"
      },
      "alertSuppressTimeInMins": 480,
      "actionGroups": [
        {
        "name": "tm-critical-actiongroup",
        "shortName": "tm-crit-ag",
        "emailReceivers": "[parameters('criticalAlertEmailReceivers')]",
        "webhookReceivers": "[parameters('criticalAlertWebhooks')]"
        },
        {
        "name": "tm-warning-actiongroup",
        "shortName": "tm-warn-ag",
        "emailReceivers": "[parameters('warningAlertEmailReceivers')]",
        "webhookReceivers": "[parameters('warningAlertWebhooks')]"
        }
      ],
      "logAlertRules": [
        {
            "name": "Azure VM - CPU Usage - Critical",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Processor' and CounterName == '% Processor Time' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "severityLevel": 0,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 2,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Computer"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - CPU Usage - Warning",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Processor' and CounterName == '% Processor Time' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "severityLevel": 1,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 2,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Computer"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure VM - Memory Usage - Critical",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Memory' and (CounterName == '% Committed Bytes In Use' or CounterName == '% Used Memory') | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "severityLevel": 0,
            "frequency": 5,
            "time": 15,   
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 1,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Computer"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - Memory Usage - Warning",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Memory' and (CounterName == '% Committed Bytes In Use' or CounterName == '% Used Memory') | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "severityLevel": 1,
            "frequency": 5,
            "time": 15,   
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 1,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Computer"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure VM - OS Disk Free Space - Critical",
            "solution": "vm-windows",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'LogicalDisk' and CounterName == '% Free Space' and InstanceName == 'C:' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 0,
            "frequency": 30,
            "time": 30,   
            "operator": "LessThan",
            "threshold": 10,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - OS Disk Free Space - Warning",
            "solution": "vm-windows",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'LogicalDisk' and CounterName == '% Free Space' and InstanceName == 'C:' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 1,
            "frequency": 30,
            "time": 30,   
            "operator": "LessThan",
            "threshold": 20,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure VM - Data Disk Free Space - Critical",
            "solution": "vm-windows",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'LogicalDisk' and CounterName == '% Free Space' and InstanceName != 'C:' and InstanceName != '_Total' and InstanceName notcontains 'Harddisk' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 0,
            "frequency": 30,
            "time": 30,   
            "operator": "LessThan",
            "threshold": 15,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - Data Disk Free Space - Warning",
            "solution": "vm-windows",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'LogicalDisk' and CounterName == '% Free Space' and InstanceName != 'C:' and InstanceName != '_Total' and InstanceName notcontains 'Harddisk' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 1,
            "frequency": 30,
            "time": 30,   
            "operator": "LessThan",
            "threshold": 5,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure VM - Disk Used Space - Critical",
            "solution": "vm-linux",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Logical Disk' and CounterName == '% Used Space' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 0,
            "frequency": 30,
            "time": 30,   
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - Disk Used Space - Warning",
            "solution": "vm-linux",
            "enabled": "true",
            "query": "Perf | where ObjectName == 'Logical Disk' and CounterName == '% Used Space' | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 30m), Computer, InstanceName",
            "severityLevel": 1,
            "frequency": 30,
            "time": 30,   
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Computer"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure VM - Agent Unreachable - Critical",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Heartbeat | summarize LastCall = max(TimeGenerated) by Computer | where LastCall < ago(20m)",
            "severityLevel": 0,
            "frequency": 5,
            "time": 60,   
            "operator": "GreaterThan",
            "threshold": 0,
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure VM - Agent Unreachable - Warning",
            "solution": "vm-generic",
            "enabled": "true",
            "query": "Heartbeat | summarize LastCall = max(TimeGenerated) by Computer | where LastCall < ago(10m)",
            "severityLevel": 1,
            "frequency": 5,
            "time": 60,   
            "operator": "GreaterThan",
            "threshold": 0,
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure SQL - DTU Usage - Critical",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'dtu_consumption_percent' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 0,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure SQL - DTU Usage - Warning",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'dtu_consumption_percent' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 1,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure SQL - CPU Usage - Critical",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'cpu_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 0,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure SQL - CPU Usage - Warning",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'cpu_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 1,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure SQL - Data Space Used - Critical",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'storage_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 30m), Resource",
            "severityLevel": 0,
            "frequency": 30,
            "time": 30,   
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Resource"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure SQL - Data Space Used - Warning",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'storage_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 30m), Resource",
            "severityLevel": 1,
            "frequency": 30,
            "time": 30,   
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
                "thresholdOperator": "GreaterThan",
                "threshold": 0,
                "metricTriggerType": "Total",
                "metricColumn": "Resource"
            },
            "actionGroup": "tm-warning-actiongroup"
        },
        {
            "name": "Azure SQL - Data IO Percentage - Critical",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'physical_data_read_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 0,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 90,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-critical-actiongroup"
        },
        {
            "name": "Azure SQL - Data IO Percentage - Warning",
            "solution": "azuresql-basic",
            "enabled": "true",
            "query": "AzureMetrics | where MetricName == 'physical_data_read_percent' and ResourceProvider == 'MICROSOFT.SQL' | summarize AggregatedValue = avg(Average) by bin(TimeGenerated, 5m), Resource",
            "severityLevel": 1,
            "frequency": 5,
            "time": 15,
            "operator": "GreaterThan",
            "threshold": 80,
            "metricTrigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 5,
            "metricTriggerType": "Consecutive",
            "metricColumn": "Resource"
            },
            "actionGroup": "tm-warning-actiongroup"
        }
        ]
    },
    "resources":[ 
      {
        "name":"[variables('logAlertRules')[copyIndex('alertrulescopy')].name]",
        "copy": { 
          "name": "alertrulescopy", 
          "count": "[length(variables('logAlertRules'))]" 
        },
        "type":"Microsoft.Insights/scheduledQueryRules",
        "condition": "[or(contains(parameters('enabledSolutions'), variables('logAlertRules')[copyIndex('alertrulescopy')].solution), contains(parameters('enabledSolutions'),'all'))]",
        "apiVersion": "2018-04-16",
        "dependsOn": [
            "[resourceId('Microsoft.Insights/actionGroups/', variables('logAlertRules')[copyIndex('alertrulescopy')].actionGroup)]"
        ],
        "location": "[resourceGroup().location]",
        "tags":{"[variables('alertTag')]": "Resource"},
        "properties":{
            "description": "[variables('logAlertRules')[copyIndex('alertrulescopy')].name]",
            "enabled": "[variables('logAlertRules')[copyIndex('alertrulescopy')].enabled]",
            "source": {
                "query": "[variables('logAlertRules')[copyIndex('alertrulescopy')].query]",
                "dataSourceId": "[variables('alertSource').SourceId]",
                "queryType":"[variables('alertSource').Type]"
            },
            "schedule":{
                "frequencyInMinutes": "[variables('logAlertRules')[copyIndex('alertrulescopy')].frequency]",
                "timeWindowInMinutes": "[variables('logAlertRules')[copyIndex('alertrulescopy')].time]"
            },
            "action":{
                "odata.type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.Microsoft.AppInsights.Nexus.DataContracts.Resources.ScheduledQueryRules.AlertingAction",
                "severity": "[variables('logAlertRules')[copyIndex('alertrulescopy')].severityLevel]",
                "throttlingInMin": "[variables('alertSuppressTimeInMins')]",
                "aznsAction":{
                    "actionGroup": "[array(resourceId('Microsoft.Insights/actionGroups/', variables('logAlertRules')[copyIndex('alertrulescopy')].actionGroup))]"
                },
                "trigger":{
                    "thresholdOperator": "[variables('logAlertRules')[copyIndex('alertrulescopy')].operator]",
                    "threshold": "[variables('logAlertRules')[copyIndex('alertrulescopy')].threshold]",
                    "metricTrigger": "[if(contains(variables('logAlertRules')[copyIndex('alertrulescopy')],'metricTrigger'), variables('logAlertRules')[copyIndex('alertrulescopy')].metricTrigger, json('null'))]"         
                }
            }
        }
      },
      {
        "type": "Microsoft.Insights/actionGroups",
        "apiVersion": "2018-03-01",
        "name": "[variables('actionGroups')[copyIndex('actiongroupscopy')].name]",
        "copy": { 
          "name": "actiongroupscopy", 
          "count": "[length(variables('actionGroups'))]" 
        },
        "location": "Global",
        "properties": {
          "groupShortName": "[variables('actionGroups')[copyIndex('actiongroupscopy')].shortName]",
          "enabled": true,
          "smsReceivers": [
          ],
          "emailReceivers": "[variables('actionGroups')[copyIndex('actiongroupscopy')].emailReceivers]",
          "webhookReceivers": "[variables('actionGroups')[copyIndex('actiongroupscopy')].webhookReceivers]"
        }
      }
    ]
}